<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts\NftAuctionFactory.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> NftAuctionFactory.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">75% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>15/20</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">27.78% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>5/18</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">37.5% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>3/8</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">70.97% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>22/31</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;
&nbsp;
import {OwnableUpgradeable} from "@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol";
import {UUPSUpgradeable} from "@openzeppelin/contracts-upgradeable/proxy/utils/UUPSUpgradeable.sol";
import {Initializable} from "@openzeppelin/contracts-upgradeable/proxy/utils/Initializable.sol";
import {ERC1967Proxy} from "@openzeppelin/contracts/proxy/ERC1967/ERC1967Proxy.sol";
import {IERC721} from "@openzeppelin/contracts/token/ERC721/IERC721.sol";
&nbsp;
import {PriceOracle} from "./PriceOracle.sol";
&nbsp;
interface IAuction {
    function initialize(
        address factory_,
        address seller_,
        address nft_,
        uint256 tokenId_,
        uint64 startTime_,
        uint64 endTime_,
        uint256 startPriceUsd_,
        address oracle_
    ) external;
}
&nbsp;
contract NftAuctionFactory is Initializable, OwnableUpgradeable, UUPSUpgradeable {
    event AuctionCreated(address indexed auction, address indexed nft, uint256 indexed tokenId, address seller);
    event ImplementationUpdated(address indexed oldImpl, address indexed newImpl);
    event FeeToSet(address indexed feeTo);
    event FeeTiersSet(uint256[] usdThresholds, uint16[] bps);
&nbsp;
    //拍卖实现合约地址
    address public auctionImplementation;
    //喂价合约
    PriceOracle public oracle;
    //手续费接收地址
    address public feeTo;
&nbsp;
    // 计费表: for bidUSD &gt;= thresholds[i], use bps[i]
    uint256[] public usdThresholds; // USD with 8 decimals
    uint16[] public bps; // fee in basis points
&nbsp;
    mapping(bytes32 =&gt; address) public auctionOf; // key(nft, tokenId) -&gt; auction
    address[] public allAuctions;
&nbsp;
    function initialize(address owner_, address implementation_, address oracle_, address feeTo_) public <span class="missing-if-branch" title="else path not taken" >E</span>initializer {
        __Ownable_init(owner_);
        __UUPSUpgradeable_init();
        auctionImplementation = implementation_;
        oracle = PriceOracle(oracle_);
        feeTo = feeTo_;
        //  &lt; $100 =&gt; 200 bps, &gt;= $1000 =&gt; 150 bps, &gt;= $10k =&gt; 100 bps
        usdThresholds = [uint256(1_0000_0000), uint256(1000_0000_0000), uint256(10_000_0000_0000)]; // 100, 1k, 10k (8 decimals)
        // 存放的是 费率，用 基点 (basis points, bps) 表示
        bps = [uint16(200), 150, 100]; //2.00%、1.50%、1.00%
    }
&nbsp;
    //限制仅合约所有者有升级权限
<span class="fstat-no" title="function not covered" >    function _authorizeUpgrade(address newImpl) internal override onlyOwner {}</span>
&nbsp;
    //可更新实现合约
<span class="fstat-no" title="function not covered" >    function setImplementation(address newImpl) external onlyOwner {</span>
<span class="cstat-no" title="statement not covered" >        emit ImplementationUpdated(auctionImplementation, newImpl);</span>
        auctionImplementation = newImpl;
    }
&nbsp;
    //设置手续费接收地址
<span class="fstat-no" title="function not covered" >    function setFeeTo(address newFeeTo) external onlyOwner {</span>
        feeTo = newFeeTo;
<span class="cstat-no" title="statement not covered" >        emit FeeToSet(newFeeTo);</span>
    }
&nbsp;
    //设置分级费率表
<span class="fstat-no" title="function not covered" >    function setFeeTiers(uint256[] calldata thresholds, uint16[] calldata bps_) external onlyOwner {</span>
<span class="cstat-no" title="statement not covered" >        require(thresholds.length == bps_.length &amp;&amp; thresholds.length &gt; 0, "bad tiers")</span>;
        usdThresholds = thresholds;
        bps = bps_;
<span class="cstat-no" title="statement not covered" >        emit FeeTiersSet(thresholds, bps_);</span>
    }
&nbsp;
    //计算手续费比例
    function feeBpsFor(uint256 bidUsd) public view returns (uint16) {
        uint16 fee = bps[0];
        for (uint256 i = 0; i &lt; usdThresholds.length; i++) {
            if (bidUsd &gt;= usdThresholds[i]) fee = bps[i];
            else break;
        }
        return fee;
    }
&nbsp;
    //创建拍卖
    //nft：NFT 合约地址
    //tokenId：拍卖的 NFT 编号
    //duration：拍卖时长（单位秒）
    //startPriceUsd：起拍价（以 USD 计价，8 位小数）
    function createAuction(
        address nft,
        uint256 tokenId,
        uint64 duration,
        uint256 startPriceUsd
    ) external returns (address auction) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(duration &gt;= 60, "duration too short");
        bytes32 key = keccak256(abi.encode(nft, tokenId));
        <span class="missing-if-branch" title="else path not taken" >E</span>require(auctionOf[key] == address(0), "exists");
        uint64 startTime = uint64(block.timestamp);
        uint64 endTime = startTime + duration;
&nbsp;
        bytes memory data = abi.encodeWithSelector(
            IAuction.initialize.selector,
            address(this),
            msg.sender,
            nft,
            tokenId,
            startTime,
            endTime,
            startPriceUsd,
            address(oracle)
        );
        auction = address(new ERC1967Proxy(auctionImplementation, data));
        auctionOf[key] = auction;
        allAuctions.push(auction);
&nbsp;
        // 转移 NFT 给拍卖合约
        // 卖家必须先在 NFT 合约里 approve 工厂合约
        IERC721(nft).safeTransferFrom(msg.sender, auction, tokenId);
        emit AuctionCreated(auction, nft, tokenId, msg.sender);
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function allAuctionsLength() external view returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >        return allAuctions.length;</span>
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Aug 22 2025 22:20:02 GMT+0800 (中国标准时间)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
